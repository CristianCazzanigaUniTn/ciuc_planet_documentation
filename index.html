<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="text/javascript" async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<title>Planet AI Technical Documentation: CiucAI</title>

    <style>

        body {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #2c3e50;

            background: 
                linear-gradient(rgba(255,255,255,0), rgba(255,255,255,0)),
                url('back.jpg') center/cover no-repeat fixed;
        }

        /* MAIN CONTAINER */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        h1 {
            color: #34495e;
            border-bottom: 3px solid #34495e;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 2em;
        }

        h2 {
            color: #2980b9;
            margin-top: 30px;
            padding-left: 12px;
            border-left: 4px solid #2980b9;
        }

        h3 {
            color: #7f8c8d;
            margin-top: 20px;
            font-size: 1.15em;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
            overflow-x: auto;
            display: block; /* mobile scroll */
        }

        th, td {
            border: 1px solid #bdc3c7;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #eaf2f8;
            color: #34495e;
            font-weight: bold;
        }

        .code-block {
            background: #f8f9fa;
            border: 1px solid #e1e4e8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            overflow-x: auto;
        }

        .formula {
            font-size: 1.25em;
            text-align: center;
            margin: 20px 0;
        }

        .note {
            background-color: #fcf8e3;
            border-left: 5px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        ul {
            padding-left: 22px;
        }

        .comparison-formula {
            color: #c0392b;
            font-weight: bold;
        }

        @media (max-width: 600px) {

            body {
                line-height: 1.5;
            }

            .container {
                margin: 0px;
                padding: 18px;
                border-radius: 0px;
                background: rgba(255, 255, 255, 0.9);
            }

            h1 {
                font-size: 1.6em;
            }

            h2 {
                font-size: 1.3em;
            }

            h3 {
                font-size: 1.1em;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px;
            }

            .formula {
                font-size: 1.1em;
            }
        }

    </style>
</head>
<body>

<div class="container">

    <p>The <code>CiucAI</code> module is a reactive and predictive artificial intelligence developed for the autonomous management of a planetary entity. Its main function is the controlled generation of resources (Carbon) and the implementation of a dynamic defensive strategy against asteroids. The AI operates on a state model that statistically adapts to external environmental conditions.</p>
    <hr>

    <h2>1. Architecture and State Model</h2>

    <h3>Data Structure (<code>CiucAI</code>)</h3>
    <p>The AI's internal state is maintained via the following key fields:</p>
    <table>
        <thead>
            <tr>
                <th>Field</th>
                <th>Type</th>
                <th>Function</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong><code>state</code></strong></td>
                <td><code>AIState</code></td>
                <td>Defines the current operating regime: <strong>SafeState</strong> or <strong>StatisticState</strong>.</td>
            </tr>
            <tr>
                <td><strong><code>estimate_sunray_ms</code></strong></td>
                <td><code>f64</code></td>
                <td>Estimate of the average time interval between Sunray events (ms). Crucial for prediction.</td>
            </tr>
            <tr>
                <td><strong><code>estimate_asteroid_ms</code></strong></td>
                <td><code>f64</code></td>
                <td>Estimate of the average time interval between Asteroid events (ms). Indicator of the threat level.</td>
            </tr>
            <tr>
                <td><strong><code>count_asteroids</code></strong></td>
                <td><code>u32</code></td>
                <td>Sampling metrics required to enable the transition to the statistical state.</td>
            </tr>
            <tr>
                <td><strong><code>count_sunrays</code></strong></td>
                <td><code>u32</code></td>
                <td>Sampling metrics required to enable the transition to the statistical state.</td>
            </tr>
            <tr>
                <td><strong><code>last_time_asteroid</code></strong></td>
                <td><code>i64</code></td>
                <td>Timestamp that rapresents the last asteroid event registred.</td>
            </tr>
            <tr>
                <td><strong><code>last_time_sunray</code></strong></td>
                <td><code>i64</code></td>
                <td>Timestamp that rapresents the last sunray event registred.</td>
            </tr>
        </tbody>
    </table>

    <h3>AI states (<code>AIState</code>)</h3>
    <table>
        <thead>
            <tr>
                <th>State</th>
                <th>Description</th>
                <th>Carbon Generation Strategy</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong><code>SafeState</code></strong></td>
                <td>Conservative state (default/fallback). Absolute priority to defense.</td>
                <td>Strict generation: requires more than <code>safe::CELLS</code> charged cells to allow the conversion of a single cell.</td>
            </tr>
            <tr>
                <td><strong><code>StatisticState</code></strong></td>
                <td>High-efficiency predictive state. Priority to efficiency based on calculated risk.</td>
                <td>Dynamic generation: variable safety threshold 1 or 2 cells based on EMA estimates.</td>
            </tr>
        </tbody>
    </table>
    <hr>

    <h2>2. Prediction and Transition Mechanisms</h2>

    <h3>Time Estimation (Exponential Moving Average - EMA)</h3>
    <p>The prediction of time intervals between events is managed using EMA with a smoothing factor alpha = 0.3. This technique provides a reactive estimate, giving more weight to recent observations.</p>
    <div class="code-block formula">
        $$
        \text{EMA}_{\text{new}} = \alpha \cdot \text{Sample} + (1 - \alpha) \cdot \text{EMA}_{\text{previous}}
        $$
        $$
        \text{Where } \alpha = 0.3
        $$
    </div>
    
    <h3>Transition Logic (<code>change_state</code>)</h3>
    <p>The state transition is conditioned by data maturity (at least 3 samples) and the risk/opportunity balance:</p>
    <ul>
        <li>
            <strong>Transition to <code>StatisticState</code>:</strong> 
            Requires Samples >= 3 and that the risk does not exceed the opportunity:
            <span class="comparison-formula"><code>estimate_asteroid_ms</code> >= <code>estimate_sunray_ms</code></span>.
            (Threat is less frequent than or equal to opportunity).
        </li>
        <li>
            <strong>Return to <code>SafeState</code>:</strong> 
            Occurs if the risk exceeds the opportunity, indicating a more dangerous environment:
            <span class="comparison-formula"><code>estimate_asteroid_ms</code> < <code>estimate_sunray_ms</code></span>.
            (Asteroids are expected more frequently than sunrays).
        </li>
    </ul>
    

    <h3>Generation Strategy in <code>StatisticState</code></h3>
    <p>
        In <strong>StatisticState</strong>, Carbon generation is handled by
        <code>generate_carbon()</code>, which delegates to
        <code>generate_carbon_statistic_state()</code>.
        The safety threshold (minimum number of charged cells to preserve) is dynamically
        modulated in real time based on risk and opportunity indicators.
    </p>
    
    <h4>Risk Modulation (Asteroid)</h4>
    <p>
        The reserved energy threshold depends on the predicted arrival time of the next asteroid:
    </p>
    <ul>
        <li><strong>Asteroid Far</strong> (elapsed time &lt; 50% of the estimate):
            <ul>
                <li>Reserve <strong>1</strong> energy cell.</li>
            </ul>
        </li>
        <li><strong>Asteroid Near</strong> (elapsed time ≥ 50% of the estimate):
            <ul>
                <li>Reserve <strong>2</strong> energy cells.</li>
            </ul>
        </li>
    </ul>
    
    <h4>Opportunity Modulation (Sunray)</h4>
    <p>
        If the time since the last sunray exceeds 75% of the estimated interval
        (tracked internally via <code>on_sunray()</code> and <code>estimate_sunray_ms</code>),
        the safety threshold is reduced by <strong>1</strong> because resupply is likely.
    </p>
    
    <ul>
        <li><strong>Asteroid Far + Opportunity Active</strong>:
            <ul>
                <li>Reserve <strong>0</strong> energy cells.</li>
            </ul>
        </li>
        <li><strong>Asteroid Near + Opportunity Active</strong>:
            <ul>
                <li>Reserve <strong>1</strong> energy cell.</li>
            </ul>
        </li>
    </ul>
    
    <p>
        This adaptive strategy allows <code>generate_carbon_statistic_state()</code> to balance
        safety and productivity depending on the predicted environmental conditions.
    </p>
    
    
    <h3>Carbon Generation in <code>SafeState</code></h3>
    <p>
        In <strong>SafeState</strong>, Carbon generation is still triggered via the central
        <code>generate_carbon()</code> function, but the logic is delegated to the
        dedicated <code>generate_carbon_safe_state()</code> strategy.
        The AI follows a conservative rule designed to preserve a stable energy buffer.
    </p>
    
    <h4>Fixed Safety Threshold</h4>
    <p>
        Carbon generation is allowed <strong>only if the number of charged energy cells exceeds
            the fixed threshold <code>safe::CELLS = 3</code></strong>.
    </p>
    
    <ul>
        <li>The planet must have <strong>at least 4 charged cells</strong> before generating Carbon.</li>
        <li>Only the excess cell beyond the threshold is consumed for Carbon production.</li>
        <li>If the threshold is not exceeded, <code>generate_carbon_safe_state()</code>
            returns an error and no energy is consumed.</li>
    </ul>
    
    <p>
        This static strategy ensures:
    </p>
    
    <ul>
        <li>A constant and predictable energy safety margin.</li>
        <li>Reliable behavior with no dynamic adjustments.</li>
        <li>Automatic transition to <code>StatisticState</code> once enough environmental data is available.</li>
    </ul>

    <hr>

    <h2>3. Event Management and Interactions</h2>

    <h3>Primary Event Handling</h3>
    <ul>
        <li><strong><code>on_sunray()</code></strong>: Updates estimate, charges the energy cell, attempts immediate rocket construction (<code>build_rocket</code>) and evaluates state transition.</li>
        <li><strong><code>on_asteroid()</code></strong>: Updates estimate, attempts deflection of an asteroid with a rocket (<code>deflect_asteroid</code>), attempts immediate rocket construction (<code>build_rocket</code>), and evaluates state transition.</li>
    </ul>

    <h3>Interaction with Protocols</h3>
    <p>
        The AI manages communications with the Orchestrator and Explorers in compliance with the game protocols
        (implementation of the <code>PlanetAI</code> trait). Each received message triggers an internal handler
        and may result in a response message being sent back.
    </p>
    
    <table>
        <thead>
            <tr>
                <th>Message (Protocol)</th>
                <th>Source</th>
                <th>Response / Action</th>
            </tr>
        </thead>
        <tbody>
    
            <!-- ORCHESTRATOR MESSAGES -->
    
            <tr>
                <td><code>Sunray</code></td>
                <td>Orchestrator</td>
                <td>
                    Execution of <code>on_sunray</code>.<br>
                    Sends <code>SunrayAck { planet_id }</code>.
                </td>
            </tr>
    
            <tr>
                <td><code>InternalStateRequest</code></td>
                <td>Orchestrator</td>
                <td>
                    Sends <code>InternalStateResponse { planet_id, planet_state }</code>.
                </td>
            </tr>
    
            <tr>
                <td><code>KillPlanet</code></td>
                <td>Orchestrator</td>
                <td>
                    Logs shutdown event.<br>
                    Sends <code>KillPlanetResult { planet_id }</code>.
                </td>
            </tr>
    
            <tr>
                <td><code>handle_asteroid</code></td>
                <td>Orchestrator</td>
                <td>
                    Execution of <code>on_asteroid</code>.<br>
                    Returns an optional <code>Rocket</code>.
                </td>
            </tr>
    
            <!-- EXPLORER MESSAGES -->
    
            <tr>
                <td><code>SupportedResourceRequest { explorer_id }</code></td>
                <td>Explorer</td>
                <td>
                    Sends <code>SupportedResourceResponse { resource_list }</code> using
                    <code>generator.all_available_recipes()</code>.
                </td>
            </tr>
    
            <tr>
                <td><code>SupportedCombinationRequest { explorer_id }</code></td>
                <td>Explorer</td>
                <td>
                    Sends <code>SupportedCombinationResponse { combination_list }</code> using
                    <code>combinator.all_available_recipes()</code>.
                </td>
            </tr>
    
            <tr>
                <td><code>GenerateResourceRequest { Carbon }</code></td>
                <td>Explorer</td>
                <td>
                    Execution of <code>generate_carbon</code>.<br>
                    If successful: sends <code>GenerateResourceResponse { Carbon }</code>.<br>
                    If failed: logs an error (no response sent).
                </td>
            </tr>
    
            <tr>
                <td><code>GenerateResourceRequest { unsupported type }</code></td>
                <td>Explorer</td>
                <td>
                    Logs that the resource cannot be generated.<br>
                    No response sent.
                </td>
            </tr>
    
            <tr>
                <td><code>CombineResourceRequest</code></td>
                <td>Explorer</td>
                <td>
                    Logs missing combination rules.<br>
                    No response sent.
                </td>
            </tr>
    
            <tr>
                <td><code>AvailableEnergyCellRequest { explorer_id }</code></td>
                <td>Explorer</td>
                <td>
                    Sends <code>AvailableEnergyCellResponse { available_cells }</code>.
                </td>
            </tr>
    
        </tbody>
    </table>

    <hr>

    <h2>4. Logging Policies</h2>
    <p>
        The <code>CiucAI</code> module uses a unified logging system to track internal actions,
        state transitions, and communication with external actors. Logs are produced through
        the internal <code>log()</code> function and follow consistent rules.
    </p>
    
    <h3>Internal Actions</h3>
    <ul>
        <li>Logged with <code>ActorType::User</code> and <code>EventType::InternalPlanetAction</code>.</li>
        <li>Channel: <code>Debug</code> or <code>Info</code> depending on relevance.</li>
        <li>Examples: EMA updates, state transitions, resource generation attempts.</li>
    </ul>
    
    <h3>Communication with Orchestrator and Explorers</h3>
    <ul>
        <li>Logged with message-related event types:</li>
        <ul>
            <li><code>MessageOrchestratorToPlanet</code></li>
            <li><code>MessagePlanetToExplorer</code></li>
        </ul>
        <li>Channels:</li>
        <ul>
            <li><code>Info</code> for normal events</li>
            <li><code>Trace</code> for acknowledgements</li>
            <li><code>Error</code> for relevant failures</li>
        </ul>
    </ul>
    
    <h3>Non-Critical Errors</h3>
    <ul>
        <li>Handled gracefully without interrupting AI behavior.</li>
        <li>Logged as <code>InternalPlanetAction</code> with channel <code>Info</code> or <code>Error</code>.</li>
        <li>Examples: failed carbon generation, inability to build rockets due to insufficient energy.</li>
    </ul>
    
    <p>
        This logging strategy ensures full traceability of decisions and communication
        while maintaining uninterrupted AI execution.
    </p>

    <hr>

    <h2>5. Tests: Validation of CiucAI Behavior</h2>

    <p>The following table summarizes the set of unit tests defined inside the <code>tests</code> module.
    Each test validates a critical aspect of the AI’s behavior, such as event handling,
    resource generation, and the correct communication with Orchestrator and Explorer.</p>

    <table>
        <thead>
            <tr>
                <th>Test Name</th>
                <th>Category</th>
                <th>Verified Function</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>

            <tr>
                <td><code>test_asteroid_with_no_rocket</code></td>
                <td>Orchestrator → Planet</td>
                <td>Asteroid handling</td>
                <td>Ensures the AI has no rockets initially and correctly answers with <em>rocket = None</em>.</td>
            </tr>

            <tr>
                <td><code>test_asteroid_with_rocket</code></td>
                <td>Orchestrator → Planet</td>
                <td>Planetary defense</td>
                <td>After receiving at least one sunray, the AI must build a rocket and use it properly.</td>
            </tr>

            <tr>
                <td><code>test_asteroid_is_the_rocket_rebuild</code></td>
                <td>Orchestrator → Planet</td>
                <td>Rocket reconstruction</td>
                <td>Validates that after every asteroid impact the rocket is automatically rebuilt.</td>
            </tr>

            <tr>
                <td><code>test_available_energy_cell_request</code></td>
                <td>Explorer → Planet</td>
                <td>Energy availability</td>
                <td>Checks that the AI correctly reports the number of charged energy cells.</td>
            </tr>

            <tr>
                <td><code>test_supported_resource_request</code></td>
                <td>Explorer → Planet</td>
                <td>Supported resources</td>
                <td>The AI must report that the only supported resource is <strong>Carbon</strong>.</td>
            </tr>

            <tr>
                <td><code>test_supported_combination_request</code></td>
                <td>Explorer → Planet</td>
                <td>Supported combinations</td>
                <td>Verifies that no resource combinations are supported (empty list).</td>
            </tr>

            <tr>
                <td><code>test_generate_carbon_safe_state</code></td>
                <td>Explorer → Planet</td>
                <td>Carbon generation (SafeState)</td>
                <td>In SafeState, generation only occurs with ≥ 4 charged cells. The test validates allowed and forbidden cases.</td>
            </tr>

            <tr>
                <td><code>test_generate_carbon_static_state</code></td>
                <td>Explorer → Planet</td>
                <td>Carbon generation (StaticState)</td>
                <td>Validates the dynamic generation thresholds based on risk/opportunity in StaticalState.</td>
            </tr>

        </tbody>
    </table>


</div>

</body>
</html>
